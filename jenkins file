node {
     def buildNumber=BUILD_NUMBER
     stage("git clone"){
           git credentialsId: 'dcc54a72-02e7-4796-b586-3a051481d64a', url: 'https://github.com/panduladdu/Python-Flask-  RestAPI.git'
    }
    stage("maven clean package"){
        sh "${mavenHome}/bin/mvn clean package"
    }
    stage('ExecutesonarqubeReport'){
     sh "${mavenHome}/bin/mvn sonar:sonar"                
    }
    stage("docker build image"){
        sh "docker build -t panduladdu/python-app:${buildNumber} ."
    }
    stage("docker login and push"){
        withCredentials([string(credentialsId: 'dockerhubpassword', variable: 'dockerhub')]) {
        sh "docker login -u panduladdu -p ${dockerhub}"
        sh "docker push panduladdu/pythoapp:${buildNumber}"
}
}
    stage("update image tag in  compose file"){
        sh "sed -i 's/TAG/${buildNumber}/g' mavenwebappdeployment.yaml"
         }
    stage("deploy to the k8s cluster"){
        sh "kubectl apply -f mavenwebappdeployment.yaml "
    }     
}
}
